<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Immersive Screen Saver Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Define custom font if needed */
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.5s, color 0.5s;
        }

        /* --- Transitions and Positioning --- */
        #dashboard, .screensaver-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transition: opacity 0.5s ease-in-out, visibility 0.5s;
            z-index: 10;
        }
        
        #dashboard { z-index: 20; } /* Dashboard layer is higher */

        /* Utility classes for smooth mode switching (same as before) */
        .visible-mode {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }
        .hidden-mode {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        /* Dark/Light Mode Backgrounds */
        .dark-mode { background-color: #111827; }
        .light-mode { background-color: #f3f4f6; }

        /* --- Screensaver Specific Styles (Display) --- */
        #timer-display, #clock-display {
            font-size: 10vw;
            line-height: 1;
            transition: font-size 0.5s ease-in-out, color 0.3s;
        }

        /* Enlarged display for true fullscreen experience */
        .is-fullscreen #timer-display, .is-fullscreen #clock-display {
            font-size: 16vw;
        }

        /* --- Screensaver Settings Sidebar --- */
        #settings-sidebar {
            position: fixed;
            top: 0;
            right: 0;
            width: 100%;
            max-width: 400px;
            height: 100%;
            z-index: 50; /* Above all content and floating controls */
            padding: 2.5rem 1.5rem;
            transform: translateX(0);
            transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1), background-color 0.3s;
            overflow-y: auto;
        }
        .sidebar-hidden {
            transform: translateX(100%);
        }
        
        /* Floating Controls (Top Right) - Smaller and more refined */
        #dashboard-controls {
            transition: opacity 0.3s ease-in-out;
            z-index: 60; /* Above the sidebar */
        }
        
        /* Fullscreen control styling */
        .is-fullscreen #dashboard-controls, .is-fullscreen #settings-sidebar {
            opacity: 0 !important;
            visibility: hidden !important;
            pointer-events: none !important;
        }
        
        /* Timer Running State - Hides sidebar (overrides when not fullscreen) */
        .timer-running #settings-sidebar {
            transform: translateX(100%);
        }

        /* Specific CSS for Dynamic Color Flow (Mode 2) */
        @keyframes colorChange {
            0% { background-color: #ef4444; } /* Red-500 */
            25% { background-color: #3b82f6; } /* Blue-500 */
            50% { background-color: #10b981; } /* Emerald-500 */
            75% { background-color: #f97316; } /* Orange-500 */
            100% { background-color: #ef4444; }
        }
        .color-flow-active {
            animation-name: colorChange;
            animation-iteration-count: infinite;
            animation-timing-function: ease-in-out;
        }
        
        /* --- Dashboard Card Animation (Fade-In) --- */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-card-in {
            animation: fadeInUp 0.6s ease-out 0.2s forwards;
            opacity: 0;
        }

        /* üöÄ REDESIGN CHANGE: OVERHAUL CARD STYLING FOR WIDE BUTTONS */
        .btn-card {
            /* Removed aspect-square to allow wide layout */
            /* Increased padding (p-6 py-10) for height, wide shadow, and strong hover effect */
            @apply w-full flex items-center justify-start py-8 px-12 rounded-3xl font-extrabold transition duration-300 shadow-xl hover:shadow-2xl hover:scale-[1.01] cursor-pointer;
        }
        
        .card-icon {
            /* Increased icon size for dominance */
            @apply text-5xl mr-8; 
        }
        .card-label {
            /* Increased label size and weight */
            @apply text-3xl font-bold leading-tight; 
        }
    </style>
</head>

<body class="dark-mode transition duration-500 ease-in-out">

    <div id="dashboard" class="visible-mode h-screen w-screen flex flex-col items-center justify-center p-8">
        
        <button onclick="toggleDarkMode()" class="absolute top-8 right-8 p-4 rounded-xl bg-white/80 dark:bg-gray-800/80 backdrop-blur-md shadow-2xl text-gray-900 dark:text-gray-100 hover:bg-gray-100 dark:hover:bg-gray-700 transition duration-300 z-50">
            <span id="dark-mode-icon-dashboard"></span>
        </button>

        <div id="dashboard-card" class="animate-card-in w-full max-w-4xl pt-12 pb-10 px-10 sm:px-14 bg-white/95 dark:bg-gray-900/95 backdrop-blur-sm rounded-[3rem] shadow-2xl border border-gray-100 dark:border-gray-700/50">
            <h1 class="text-5xl font-extrabold mb-10 text-center text-gray-900 dark:text-gray-100">
                Screen Saver Studio
            </h1>
            
            <div id="mode-description-card" class="mb-14 p-8 rounded-3xl bg-gray-50/70 dark:bg-gray-800/70 backdrop-blur-sm transition-all duration-300 shadow-xl text-center h-40 flex flex-col justify-center border border-gray-200 dark:border-gray-700">
                <h2 id="desc-title" class="text-2xl font-extrabold text-gray-900 dark:text-gray-100 mb-2 transition-colors duration-300">
                    üëã Select a Screen Saver Mode
                </h2>
                <p id="desc-text" class="text-lg text-gray-600 dark:text-gray-400 transition-colors duration-300">
                    Hover over any option below to see a detailed description.
                </p>
            </div>

            <div class="grid grid-cols-1 gap-6 w-full mx-auto justify-center">
                
                <button onclick="setMode('timer')" class="btn-card bg-indigo-600 text-white hover:bg-indigo-700" 
                    onmouseover="setModeDescription('timer')" onmouseout="setModeDescription('default')">
                    <span class="card-icon">‚è≤Ô∏è</span>
                    <span class="card-label">Digital Countdown Timer</span>
                </button>
                
                <button onclick="setMode('color-flow')" class="btn-card bg-pink-600 text-white hover:bg-pink-700"
                    onmouseover="setModeDescription('color-flow')" onmouseout="setModeDescription('default')">
                    <span class="card-icon">üåà</span>
                    <span class="card-label">Dynamic Color Flow</span>
                </button>
                
                <button onclick="setMode('clock')" class="btn-card bg-yellow-600 text-white hover:bg-yellow-700"
                    onmouseover="setModeDescription('clock')" onmouseout="setModeDescription('default')">
                    <span class="card-icon">‚è∞</span>
                    <span class="card-label">Current Digital Time</span>
                </button>
                
            </div>
        </div>
    </div>

    <div id="screensaver-view" class="screensaver-container hidden-mode">
        
        <div id="dashboard-controls" class="controls-panel absolute top-8 right-8 z-60 flex space-x-3 p-3 bg-white/70 dark:bg-gray-900/70 backdrop-blur-md rounded-2xl shadow-xl">
            <button onclick="goFullscreen()" class="p-2 rounded-xl bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-gray-100 hover:bg-gray-300 dark:hover:bg-gray-600 transition">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-maximize-2"><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" x2="14" y1="3" y2="10"/><line x1="3" x2="10" y1="21" y2="14"/></svg>
            </button>
            <button onclick="toggleDarkMode()" class="p-2 rounded-xl bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-gray-100 hover:bg-gray-300 dark:hover:bg-gray-600 transition">
                <span id="dark-mode-icon"></span>
            </button>
            <button onclick="setMode('dashboard')" class="p-2 rounded-xl bg-red-500 text-white hover:bg-red-600 transition">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
            </button>
        </div>
        
        <div id="settings-sidebar" class="sidebar-hidden bg-white/70 dark:bg-gray-800/70 backdrop-blur-md shadow-2xl text-gray-900 dark:text-gray-100 flex flex-col space-y-8">
            <h2 id="sidebar-title" class="text-3xl font-bold mb-4 border-b border-gray-300 dark:border-gray-700 pb-4">Mode Settings</h2>
            <div id="mode-settings-panel" class="flex flex-col space-y-6">
                </div>
        </div>

        <div id="mode-content" class="h-full w-full flex items-center justify-center relative">
            </div>

    </div>

    <script>
        // --- Global State and Constants (Unchanged) ---
        const $ = (id) => document.getElementById(id);
        
        const STATE = {
            mode: 'dashboard',
            isDarkMode: true,
            timer: {
                initialSeconds: 300,
                remainingSeconds: 300,
                isRunning: false,
                intervalId: null,
                bgColor: '#2563EB', 
                isFullScreen: false,
                wakeLock: null,
            },
            colorFlow: {
                speed: 3000,
            },
            clockInterval: null,
        };

        const THEMES = {
            light: { bg: '#f3f4f6', text: '#1f2937', cardBg: 'bg-white/95', cardDarkBg: 'bg-gray-800/90' },
            dark: { bg: '#111827', text: '#f3f4f6', cardBg: 'bg-gray-900/95', cardDarkBg: 'bg-gray-800/90' },
        };

        const MODE_DETAILS = {
            'default': { icon: 'üëã', title: 'Select a Screen Saver Mode', description: 'Hover over any option below to see a detailed description.' },
            'timer': { icon: '‚è≤Ô∏è', title: 'Digital Timer (Countdown)', description: 'A full-screen timer that counts down from an adjustable time. Keeps your screen awake while running.' },
            'color-flow': { icon: 'üåà', title: 'Dynamic Color Flow', description: 'A blank screen with background colors that smoothly cycle through the spectrum. Control the transition speed.' },
            'clock': { icon: '‚è∞', title: 'Current Digital Time', description: 'A minimal clock displaying the current time and date on a full-screen background.' },
        };

        // --- Utility Functions (Unchanged) ---
        function formatTime(totalSeconds) {
            if (totalSeconds < 0) totalSeconds = 0;
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            const pad = (num) => String(num).padStart(2, '0');
            return hours > 0 ? `${pad(hours)}:${pad(minutes)}:${pad(seconds)}` : `${pad(minutes)}:${pad(seconds)}`;
        }

        // --- Core UI Management (Unchanged) ---

        function setMode(newMode) {
            cleanupMode(STATE.mode);

            STATE.mode = newMode;
            const $dashboard = $('dashboard');
            const $screensaverView = $('screensaver-view');
            const $modeContent = $('mode-content');
            const $sidebar = $('settings-sidebar');
            
            $modeContent.innerHTML = '';
            $screensaverView.classList.remove('color-flow-active', 'timer-running');
            $screensaverView.style.backgroundColor = '';
            $sidebar.classList.add('sidebar-hidden'); 

            const transitionDuration = 500;
            const $dashboardCard = $('dashboard-card');

            if (newMode === 'dashboard') {
                $screensaverView.classList.replace('visible-mode', 'hidden-mode');
                
                setTimeout(() => {
                    $dashboard.classList.replace('hidden-mode', 'visible-mode');
                    if ($dashboardCard) {
                        $dashboardCard.classList.remove('animate-card-in');
                        void $dashboardCard.offsetWidth; 
                        $dashboardCard.classList.add('animate-card-in');
                    }
                }, transitionDuration); 

                document.body.classList.remove('is-fullscreen');
                STATE.timer.isFullScreen = false;
                if(document.fullscreenElement) document.exitFullscreen();
                setModeDescription('default');
            } else {
                $dashboard.classList.replace('visible-mode', 'hidden-mode');
                
                if ($dashboardCard) $dashboardCard.classList.remove('animate-card-in');

                setTimeout(() => {
                    $screensaverView.classList.replace('hidden-mode', 'visible-mode');
                    initMode(newMode);
                }, transitionDuration); 
            }
        }
        
        function setModeDescription(modeKey) {
            const details = MODE_DETAILS[modeKey] || MODE_DETAILS['default'];
            const $title = $('desc-title');
            const $text = $('desc-text');
            
            if ($title) $title.innerHTML = `${details.icon} ${details.title}`;
            if ($text) $text.innerHTML = details.description;
        }

        function initMode(mode) {
            const $modeContent = $('mode-content');
            const $settingsPanel = $('mode-settings-panel');
            const $sidebar = $('settings-sidebar');
            const theme = STATE.isDarkMode ? THEMES.dark : THEMES.light;
            
            $settingsPanel.innerHTML = '';
            $('sidebar-title').textContent = MODE_DETAILS[mode].title + ' Settings';
            $('screensaver-view').style.backgroundColor = theme.bg;

            switch (mode) {
                case 'timer':
                    renderTimer($modeContent);
                    renderTimerControls($settingsPanel);
                    $sidebar.classList.remove('sidebar-hidden');
                    break;
                case 'clock':
                    renderClock($modeContent);
                    $sidebar.classList.add('sidebar-hidden');
                    break;
                case 'color-flow':
                    renderColorFlow($modeContent);
                    renderColorFlowControls($settingsPanel);
                    $sidebar.classList.remove('sidebar-hidden');
                    break;
            }
        }

        function cleanupMode(mode) {
            switch (mode) {
                case 'timer':
                    stopTimer();
                    STATE.timer.isRunning = false;
                    STATE.timer.remainingSeconds = STATE.timer.initialSeconds;
                    break;
                case 'clock':
                    if (STATE.clockInterval) clearInterval(STATE.clockInterval);
                    STATE.clockInterval = null;
                    break;
                case 'color-flow':
                    break;
            }
        }
        
        // --- Wake Lock API Functions (Unchanged) ---
        async function requestWakeLock() {
             if ('wakeLock' in navigator) {
                try {
                    STATE.timer.wakeLock = await navigator.wakeLock.request('screen');
                    STATE.timer.wakeLock.addEventListener('release', () => {
                        if (STATE.timer.isRunning) requestWakeLock();
                    });
                } catch (err) {
                    console.error(`Wake Lock failed: ${err.name}`);
                }
            }
        }
        function releaseWakeLock() {
            if (STATE.timer.wakeLock) {
                STATE.timer.wakeLock.release().then(() => { STATE.timer.wakeLock = null; });
            }
        }


        // --- Dark Mode (Unchanged) ---
        function updateDarkModeIcons() {
            const iconHtml = STATE.isDarkMode 
                ? '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sun"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>' 
                : '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-moon-star"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/><path d="M16 4.7l.6.5"/><path d="M17.8 7l.5-.6"/><path d="M15.4 10.3l-.6.5"/><path d="M14.2 7l-.5-.6"/></svg>';

            const $dmIcon = $('dark-mode-icon');
            const $dmIconDashboard = $('dark-mode-icon-dashboard');

            if ($dmIcon) $dmIcon.innerHTML = iconHtml;
            if ($dmIconDashboard) $dmIconDashboard.innerHTML = iconHtml;
        }

        function toggleDarkMode() {
            STATE.isDarkMode = !STATE.isDarkMode;
            document.body.classList.toggle('dark-mode', STATE.isDarkMode);
            document.body.classList.toggle('light-mode', !STATE.isDarkMode);
            
            updateDarkModeIcons();

            if (STATE.mode !== 'dashboard') {
                const isRunning = STATE.timer.isRunning; 
                cleanupMode(STATE.mode);
                initMode(STATE.mode);
                if (STATE.mode === 'timer' && isRunning) {
                    STATE.timer.isRunning = true;
                    toggleTimer(true);
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
             STATE.isDarkMode = true;
             document.body.classList.add('dark-mode');
             updateDarkModeIcons();
             setModeDescription('default');
        });


        // --- Fullscreen Handling (Unchanged) ---
        function goFullscreen() {
            const elem = $('screensaver-view');
            if (elem.requestFullscreen) {
                elem.requestFullscreen();
            } else if (elem.webkitRequestFullscreen) {
                elem.webkitRequestFullscreen();
            } else if (elem.msRequestFullscreen) {
                elem.msRequestFullscreen();
            }
            STATE.timer.isFullScreen = true;
            document.body.classList.add('is-fullscreen');
        }

        document.addEventListener('fullscreenchange', () => {
            const isFullScreen = document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement;
            STATE.timer.isFullScreen = !!isFullScreen;

            if (!isFullScreen) {
                document.body.classList.remove('is-fullscreen');
            }
        });


        // --- MODE 1: Digital Timer (Countdown) (Logic Unchanged) ---

        function renderTimer($container) {
            const theme = STATE.isDarkMode ? THEMES.dark : THEMES.light;
            $container.innerHTML = `
                <div id="timer-display" class="font-mono font-extrabold" style="color: ${theme.text};">
                    ${formatTime(STATE.timer.remainingSeconds)}
                </div>
            `;
            $('screensaver-view').style.backgroundColor = STATE.timer.bgColor;
        }

        function renderTimerControls($container) {
            $container.innerHTML = `
                <h3 class="text-xl font-semibold border-b border-gray-200 dark:border-gray-700 pb-3">Time Adjustment</h3>
                
                <div class="flex space-x-4 w-full justify-center">
                    <button onclick="adjustTime(-300)" class="flex-1 p-3 bg-red-100 dark:bg-red-900 rounded-xl hover:bg-red-200 dark:hover:bg-red-700 transition shadow-md text-sm">
                        <span class="font-bold block mb-1">- 5 MIN</span>
                    </button>
                    <button onclick="adjustTime(-60)" class="flex-1 p-3 bg-red-100 dark:bg-red-900 rounded-xl hover:bg-red-200 dark:hover:bg-red-700 transition shadow-md text-sm">
                        <span class="font-bold block mb-1">- 1 MIN</span>
                    </button>
                    <button onclick="adjustTime(60)" class="flex-1 p-3 bg-green-100 dark:bg-green-900 rounded-xl hover:bg-green-200 dark:hover:bg-green-700 transition shadow-md text-sm">
                        <span class="font-bold block mb-1">+ 1 MIN</span>
                    </button>
                    <button onclick="adjustTime(300)" class="flex-1 p-3 bg-green-100 dark:bg-green-900 rounded-xl hover:bg-green-200 dark:hover:bg-green-700 transition shadow-md text-sm">
                        <span class="font-bold block mb-1">+ 5 MIN</span>
                    </button>
                </div>
                
                <div class="flex space-x-4 w-full justify-center pt-4 border-t border-gray-200 dark:border-gray-700">
                    <button id="timer-start-btn" onclick="toggleTimer()" class="flex-1 bg-green-600 text-white hover:bg-green-700 p-4 rounded-xl shadow-lg transition text-xl font-bold flex items-center justify-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-play"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                        <span>Start</span>
                    </button>
                    <button onclick="resetTimer()" class="flex-1 bg-gray-500 text-white hover:bg-gray-600 p-4 rounded-xl shadow-lg transition text-xl font-bold flex items-center justify-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-rotate-ccw"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-3.6 5.8 4.5 4.5 0 0 1-5 4.8"/></svg>
                        <span>Reset</span>
                    </button>
                </div>
                
                <div class="flex items-center justify-between pt-6 border-t border-gray-200 dark:border-gray-700">
                    <span class="font-semibold text-lg">Background Color:</span>
                    <input type="color" id="bg-color-picker" value="${STATE.timer.bgColor}" onchange="changeTimerBgColor(this.value)" class="w-16 h-12 rounded-xl cursor-pointer border-4 border-gray-300 dark:border-gray-700 p-1 shadow-inner">
                </div>
            `;
            updateTimerButtonState();
        }

        function updateTimerButtonState() {
             const $startBtn = $('timer-start-btn');
             if (!$startBtn) return;
             
             if (STATE.timer.isRunning) {
                 $startBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pause"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg><span>Pause</span>';
                 $startBtn.classList.replace('bg-green-600', 'bg-orange-600');
                 $startBtn.classList.replace('hover:bg-green-700', 'hover:bg-orange-700');
             } else {
                 $startBtn.innerHTML = STATE.timer.remainingSeconds === 0 ? '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-play"><polygon points="5 3 19 12 5 21 5 3"/></svg><span>Start</span>' : '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-play"><polygon points="5 3 19 12 5 21 5 3"/></svg><span>Resume</span>';
                 $startBtn.classList.replace('bg-orange-600', 'bg-green-600');
                 $startBtn.classList.replace('hover:bg-orange-700', 'hover:bg-green-700');
             }
        }

        function adjustTime(deltaSeconds) {
            if (STATE.timer.isRunning) return;
            
            STATE.timer.initialSeconds = Math.max(0, STATE.timer.initialSeconds + deltaSeconds);
            STATE.timer.remainingSeconds = STATE.timer.initialSeconds;
            
            const $display = $('timer-display');
            if ($display) $display.textContent = formatTime(STATE.timer.remainingSeconds);
        }

        function toggleTimer(forceRestart = false) {
            STATE.timer.isRunning = !STATE.timer.isRunning;
            const $screensaverView = $('screensaver-view');

            if (STATE.timer.isRunning || forceRestart) {
                if (!forceRestart) {
                    startTimer();
                }
                $screensaverView.classList.add('timer-running');
            } else {
                stopTimer();
                $screensaverView.classList.remove('timer-running');
            }
            updateTimerButtonState();
        }

        function startTimer() {
            if (STATE.timer.intervalId) clearInterval(STATE.timer.intervalId);

            STATE.timer.intervalId = setInterval(() => {
                STATE.timer.remainingSeconds--;

                const $display = $('timer-display');
                if ($display) $display.textContent = formatTime(STATE.timer.remainingSeconds);
                
                if (STATE.timer.remainingSeconds <= 0) {
                    stopTimer();
                    STATE.timer.isRunning = false;
                    $display.textContent = "TIME'S UP!";
                    $display.classList.add('animate-pulse', 'text-red-500');
                    
                    $('screensaver-view').classList.remove('timer-running');
                    updateTimerButtonState();
                }
            }, 1000);

            requestWakeLock();
        }

        function stopTimer() {
            if (STATE.timer.intervalId) clearInterval(STATE.timer.intervalId);
            STATE.timer.intervalId = null;
            releaseWakeLock();
        }

        function resetTimer() {
            stopTimer();
            STATE.timer.isRunning = false;
            STATE.timer.remainingSeconds = STATE.timer.initialSeconds;
            
            const $display = $('timer-display');
            if ($display) {
                $display.textContent = formatTime(STATE.timer.remainingSeconds);
                $display.classList.remove('animate-pulse', 'text-red-500');
            }
            
            $('screensaver-view').classList.remove('timer-running');
            updateTimerButtonState();
        }

        function changeTimerBgColor(colorHex) {
            STATE.timer.bgColor = colorHex;
            $('screensaver-view').style.backgroundColor = colorHex;
        }

        // --- MODE 3: Current Time (Clock) (Logic Unchanged) ---

        function renderClock($container) {
            const theme = STATE.isDarkMode ? THEMES.dark : THEMES.light;
            $container.innerHTML = `
                <div class="flex flex-col items-center justify-center">
                    <div id="clock-display" class="font-mono font-extrabold text-center" style="color: ${theme.text};">
                        --:--:--
                    </div>
                    <p id="date-display" class="text-3xl mt-4 font-light transition-colors duration-300" style="color: ${theme.text}99;"></p>
                </div>
            `;
            startClock();
        }

        function startClock() {
            const $clockDisplay = $('clock-display');
            const $dateDisplay = $('date-display');
            
            function updateTime() {
                const now = new Date();
                const hours = now.getHours();
                const minutes = now.getMinutes();
                const seconds = now.getSeconds();

                const timeString = `${String(hours % 12 || 12).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')} ${hours >= 12 ? 'PM' : 'AM'}`;
                const dateString = now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                
                if ($clockDisplay) $clockDisplay.textContent = timeString;
                if ($dateDisplay) $dateDisplay.textContent = dateString;
            }

            updateTime();
            STATE.clockInterval = setInterval(updateTime, 1000);
        }

        // --- MODE 2: Dynamic Color Flow (Frequency) (Logic Unchanged) ---

        function renderColorFlow() {
            const $screensaverView = $('screensaver-view');
            $screensaverView.classList.add('color-flow-active');
            $screensaverView.style.animationDuration = `${STATE.colorFlow.speed}ms`;
        }

        function renderColorFlowControls($container) {
            $container.innerHTML = `
                <h3 class="text-xl font-semibold border-b border-gray-200 dark:border-gray-700 pb-3">Transition Speed</h3>
                <div class="flex flex-col space-y-4">
                    <p class="text-sm text-gray-700 dark:text-gray-300">Adjust the time it takes for the background to complete one full color transition.</p>
                    <input type="range" min="500" max="10000" value="${STATE.colorFlow.speed}" id="speed-slider" oninput="updateColorFlowSpeed(this.value)" class="w-full h-3 rounded-full appearance-none cursor-pointer accent-pink-500 shadow-inner">
                    <p class="text-2xl font-semibold pt-2 text-center">
                        Cycle Time: <span id="speed-value" class="font-bold text-pink-500">${(STATE.colorFlow.speed / 1000).toFixed(1)}</span> seconds
                    </p>
                </div>
            `;
        }
        
        function updateColorFlowSpeed(value) {
            const speedMs = parseInt(value);
            STATE.colorFlow.speed = speedMs;
            
            $('speed-value').textContent = (speedMs / 1000).toFixed(1);
            $('screensaver-view').style.animationDuration = `${speedMs}ms`;
        }

    </script>

</body>
</html>
